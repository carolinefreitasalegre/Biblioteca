@page "/adicionar-livro"
@inherits ComponentBase
@attribute [Authorize(Roles = "Usuario")]
@inject ILivroService _service
@inject NotificationService NotificationService

<RadzenTemplateForm Data="@Livro" TItem="LivroRequest" Submit="Salvar" Style="width: 100%;">

    <div class="row">

        <div class="col-12 col-md-8 mb-4">
            <RadzenCard>
                <div class="card-title">Informações Básicas</div>

                <div class="row mt-3">

                    <div class="col-12 col-md-6 mb-3">
                        <RadzenLabel Text="Título" Component="Titulo" />
                        <RadzenTextBox Name="Titulo" @bind-Value="@Livro.Titulo" Placeholder="Digite o título do livro" Style="width:100%" />
                        <RadzenRequiredValidator Text="Campo obrigatório" Component="Titulo" />
                    </div>

                    <div class="col-12 col-md-6 mb-3">
                        <RadzenLabel Text="Autor" Component="Autor" />
                        <RadzenTextBox Name="Autor" @bind-Value="@Livro.Autor" Placeholder="Nome do autor" Style="width:100%" />
                        <RadzenRequiredValidator Text="Campo obrigatório" Component="Autor" />
                    </div>

                    <div class="col-12 col-md-6 mb-3">
                        <RadzenLabel Text="Editora" Component="Editora" />
                        <RadzenTextBox Name="Editora" @bind-Value="@Livro.Editora" Placeholder="Nome da editora" Style="width:100%" />
                    </div>
                    
                    <div class="col-12 col-md-6 mb-3">
                        <RadzenLabel Text="Isbn" Component="Isbn" />
                        <RadzenTextBox Name="Isbn" @bind-Value="@Livro.Isbn" Placeholder="Isbn" Style="width:100%" />
                    </div>

                    <div class="col-12 col-md-6 mb-3">
                        <RadzenLabel Text="Ano de Publicação" Component="Ano" />
                        <RadzenDatePicker TValue="DateTime?"
                                          @bind-Value="AnoPublicacaoUi"
                                          DateFormat="dd/MM/yyyy"
                                          Style="width:100%" />



                    </div>

                    <div class="col-12 col-md-6 mb-3">
                        <RadzenLabel Text="Número de Páginas" Component="Paginas" />
                        <RadzenNumeric Name="Paginas" @bind-Value="@Livro.NumeroPaginas" Style="width:100%" TValue="int?" />
                    </div>

                    <div class="col-12 col-md-6 mb-3">
                        <RadzenLabel Text="Categoria" Component="Categoria" />
                        <RadzenDropDown Name="Categoria" Style="width:100%"
                                        @bind-Value="@Livro.Categoria"
                                        Data="@Categorias"
                                        TextProperty="Text"
                                        ValueProperty="Value"
                                        Placeholder="Selecione uma categoria" />
                    </div>

                </div>
            </RadzenCard>
        </div>

        <!--  CAPA DO LIVRO (UPLOAD)                  -->
        <div class="col-12 col-md-4 mb-4">
            <RadzenCard>

                <div class="card-title">Capa do Livro</div>

                <div class="d-flex flex-column align-items-center text-center mt-3">

                    @if (CapaPreviewBase64 != null)
                    {
                        <img src="@CapaPreviewBase64" style="width:160px; height:auto; border-radius:6px; margin-bottom:15px;" />
                    }
                    else
                    {
                        <div style="border:2px dashed #ccc; border-radius:10px; width:160px; height:200px; display:flex; align-items:center; justify-content:center;">
                            <i class="rz-icon-file-upload" style="font-size:40px; opacity:0.4"></i>
                        </div>
                    }

                    <RadzenFileInput TValue="UploadChangeEventArgs" Change="UploadCapa" />

                </div>

            </RadzenCard>
        </div>

        <!--   STATUS DE LEITURA                      -->
        <div class="col-12 mb-4">
            <RadzenCard>

                <div class="card-title">Status de Leitura</div>

                <div class="row mt-3">

                    <div class="col-12 col-md-4 mb-3">
                        <RadzenLabel Text="Status Atual" Component="Status" />
                        <RadzenDropDown Name="Status" Style="width:100%"
                                        @bind-Value="@Livro.StatusLeitura"
                                        Data="@StatusList" 
                                        TextProperty="Text"
                                        ValueProperty="Value"
                        />
                    </div>

                    <div class="col-12 mb-3">
                        <RadzenLabel Text="Notas Pessoais" Component="Notas" />
                        <RadzenTextArea Name="Notas" @bind-Value="Livro.NotasPessoais" 
                                        Placeholder="Suas impressões, citações favoritas, etc..." 
                                        Style="width:100%; min-height:120px;" />
                    </div>

                </div>

            </RadzenCard>
        </div>

        
        <div class="col-12 mb-4">
            <RadzenCard>

                <div class="card-title">Tags</div>

                <RadzenLabel Text="Adicione tags para organizar seus livros" />

                <div class="d-flex gap-2 mt-2">

                    <RadzenTextBox Style="flex:1" @bind-Value="@NovaTag" Placeholder="Digite uma tag..." />
                    
                    <RadzenButton Text="+" Click="@AdicionarTag" ButtonStyle="ButtonStyle.Primary" />
                </div>

                 <div class="mt-3"> 
                @*     @foreach (var tag in Livro.Tags) *@
                @*     { *@
                @*         <span class="badge bg-secondary me-2"> *@
                @*             @tag *@
                @*         </span> *@
                @*     } *@
                </div> 

            </RadzenCard>
        </div>


        <div class="col-12 text-end mt-4">
            <RadzenButton Text="Salvar Livro" ButtonStyle="ButtonStyle.Success" Icon="check" ButtonType="ButtonType.Submit" />
        </div>

    </div>

</RadzenTemplateForm>


@code {
    private DateTime? AnoPublicacaoUi;
    private LivroRequest Livro = new();
    private string? CapaPreviewBase64;
    private string NovaTag = "";

    private IEnumerable<object> StatusList => Enum.GetValues(typeof(EStatusLeitura)).Cast<EStatusLeitura>()
        .Select(s => new
        {
            Text = s.GetDisplayName(),
            Value = s
        });

    private IEnumerable<object> Categorias => Enum.GetValues(typeof(ECategoriaLivro)).Cast<ECategoriaLivro>()
        .Select(c => new
        {
            Text = c.GetDisplayName(),
            Value = c
        });

    private async Task UploadCapa(UploadChangeEventArgs args)
    {
        var file = args.Files.FirstOrDefault();
        if (file == null) return;

        using var stream = file.OpenReadStream(5_000_000);
        using var ms = new MemoryStream();

        await stream.CopyToAsync(ms);

        CapaPreviewBase64 = $"data:image/png;base64,{Convert.ToBase64String(ms.ToArray())}";
    }

    private void AdicionarTag()
    {
        if (!string.IsNullOrWhiteSpace(NovaTag))
        {
        //     Model.Tags.Add(NovaTag.Trim());
        //     NovaTag = "";
        }
    }

    
    
    private async Task Salvar(LivroRequest livro)
    {
        try
        {
            if (AnoPublicacaoUi.HasValue)
            {
                livro.AnoPublicacao = DateOnly.FromDateTime(AnoPublicacaoUi.Value);
            }

            await _service.AdicionarLivros(livro);
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Sucesso!",
                Detail = "Livro adicionado com sucesso",
                Duration = 4000 
            });
        }
        catch (Exception e)
        {
            Console.WriteLine($"Erro ao salvar: {e.Message}");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Erro!",
                Detail = "Algo deu errado ao salvar os dados. Verifique os campos e tente novamente!!!",
                Duration = 4000 
            });
        }

    }
   
}
