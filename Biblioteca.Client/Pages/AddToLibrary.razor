@page "/adicionar-livro"
@inherits ComponentBase
@attribute [Authorize]
@inject ILivroService _service
@inject NotificationService NotificationService

<RadzenTemplateForm Data="@Livro" TItem="LivroRequest" Submit="Salvar" Style="width: 100%;">
    
    <div class="rz-p-0 rz-p-md-4">
        <RadzenRow Gap="2rem">
            
            <RadzenColumn Size="12" SizeMD="8">
                <RadzenStack Gap="1.5rem">
                    
                    <RadzenCard>
                        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-4">Informações Básicas</RadzenText>
                        <RadzenRow Gap="1rem">
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenLabel Text="Título" Component="Titulo" class="rz-display-block" />
                                <RadzenTextBox Name="Titulo" @bind-Value="Livro.Titulo" Placeholder="Digite o título" Style="width:100%" />
                                <RadzenRequiredValidator Text="Obrigatório" Component="Titulo" />
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenLabel Text="Autor" Component="Autor" class="rz-display-block" />
                                <RadzenTextBox Name="Autor" @bind-Value="Livro.Autor" Placeholder="Nome do autor" Style="width:100%" />
                                <RadzenRequiredValidator Text="Obrigatório" Component="Autor" />
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenLabel Text="Editora" Style="display:block" />
                                <RadzenTextBox @bind-Value="Livro.Editora" Placeholder="Nome da editora" Style="width:100%" />
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenLabel Text="ISBN" Style="display:block" />
                                <RadzenTextBox @bind-Value="Livro.Isbn" Placeholder="ISBN" Style="width:100%" />
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenLabel Text="Ano de Publicação" Style="display:block" />
                                <RadzenDatePicker TValue="DateTime?" @bind-Value="AnoPublicacaoUi" DateFormat="dd/MM/yyyy" Style="width:100%"
                                                  Placeholder="00/00/00"/>
                            </RadzenColumn>

                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenLabel Text="Páginas" Component="Paginas" Style="display:block" />
                                <RadzenNumeric Name="Paginas" TValue="int?" @bind-Value="Livro.NumeroPaginas" Style="width:100%"
                                               Placeholder="Digite o número de páginas"/>
                                <RadzenRequiredValidator Text="Obrigatório" Component="Paginas" />
                            </RadzenColumn>

                            <RadzenColumn Size="12">
                                <RadzenLabel Text="Categoria" Component="Categoria" Style="display:block" />
                                <RadzenDropDown @bind-Value="Livro.Categoria" Data="@Categorias" TextProperty="Text" ValueProperty="Value" Style="width:100%" 
                                                Placeholder="Selecione a categoria"/>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenCard>

                    <RadzenCard>
                        <RadzenText TextStyle="TextStyle.H6" class="rz-mb-4">Status de Leitura</RadzenText>
                        <RadzenRow Gap="1rem">
                            <RadzenColumn Size="12" SizeMD="5">
                                <RadzenLabel Text="Status Atual" Style="display:block" />
                                <RadzenDropDown @bind-Value="Livro.StatusLeitura" Data="@StatusList" TextProperty="Text" ValueProperty="Value" Style="width:100%" 
                                                Placeholder="Selecione o status de leitura"/>
                            </RadzenColumn>

                            <RadzenColumn Size="12">
                                <RadzenLabel Text="Notas Pessoais" Style="display:block" />
                                <RadzenTextArea @bind-Value="Livro.NotasPessoais" Placeholder="Suas impressões..." Style="width:100%; min-height:100px;" />
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenCard>

                </RadzenStack>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="4">
                <RadzenCard Style="height: 100%;">
                    <RadzenText TextStyle="TextStyle.H6" class="rz-mb-4">Capa do Livro</RadzenText>
                    
                    <RadzenStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" class="rz-mt-2">
                        @if (!string.IsNullOrEmpty(capaPreview))
                        {
                            <RadzenImage Path="@capaPreview" Style="width: 100%; max-width: 200px; border-radius: 8px; " />
                        }
                        else
                        {
                            <div style="border: 2px dashed ; width: 100%; max-width: 200px; aspect-ratio: 2/3; display: flex; align-items: center; justify-content: center;">
                                <RadzenIcon Icon="image" Style="font-size: 48px; " />
                            </div>
                        }

                        <div class="rz-mt-4" style="width: 100%;">
                            <RadzenLabel Text="Alterar Capa" class="rz-mb-2" />
                            <InputFile OnChange="CapturarArquivo" class="form-control" style="width: 100%;" />
                        </div>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

        </RadzenRow>

        <div class="rz-text-align-right rz-mt-4">
            <RadzenButton Text="Salvar Livro" Icon="save" ButtonType="ButtonType.Submit" Style="background-color: var(--btn)" />
        </div>
    </div>

</RadzenTemplateForm>

@code {
    private DateTime? AnoPublicacaoUi;
    private LivroRequest Livro = new();
    private IBrowserFile capaLivro;
    private string? capaPreview;
    
    
    private IEnumerable<object> StatusList => Enum.GetValues(typeof(EStatusLeitura)).Cast<EStatusLeitura>()
        .Select(s => new
        {
            Text = s.GetDisplayName(),
            Value = s
        });

    private IEnumerable<object> Categorias => Enum.GetValues(typeof(ECategoriaLivro)).Cast<ECategoriaLivro>()
        .Select(c => new
        {
            Text = c.GetDisplayName(),
            Value = c
        });


    void OnChange(string value, string name)
    {
        capaPreview = value; 
    }
    
    
    private async Task CapturarArquivo(InputFileChangeEventArgs e)
    {
        capaLivro = e.File;

        var format = "image/png";
        var resizedImage = await e.File.RequestImageFileAsync(format, 300, 300);
        var buffer = new byte[resizedImage.Size];
        await resizedImage.OpenReadStream().ReadAsync(buffer);
        capaPreview = $"data:{format};base64,{Convert.ToBase64String(buffer)}";
        
        Livro.CapaUrl = capaPreview;
    }
    
    
    private async Task Salvar(LivroRequest livro)
    {
        if (string.IsNullOrWhiteSpace(livro.Titulo))
        {
            NotificarCampoObrigatorio("Título");
            return;
        }

        if (string.IsNullOrWhiteSpace(livro.Autor))
        {
            NotificarCampoObrigatorio("Autor");
            return;
        }

        if (string.IsNullOrEmpty(livro.CapaUrl))
        {
            NotificarCampoObrigatorio("Capa do Livro");
            return;
        }

        if (livro.StatusLeitura == 0)
        {
            NotificarCampoObrigatorio("Status de Leitura obrigatório.");
            return;
        }

        if (livro.Categoria == 0)
        {
            NotificarCampoObrigatorio("Categoria obrigatória.");
            return;
        }

        if (livro.NumeroPaginas == null)
        {
            NotificarCampoObrigatorio("Número de páginas obrigatório.");
            return;
        }
        try
        {
            if (AnoPublicacaoUi.HasValue)
            {
                livro.AnoPublicacao = DateOnly.FromDateTime(AnoPublicacaoUi.Value);
            }

            await _service.AdicionarLivros(livro, capaLivro);
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Sucesso!",
                Detail = "Livro adicionado com sucesso",
                Duration = 4000 
            });

            Livro = new LivroRequest();
            AnoPublicacaoUi = null;
            capaLivro = null;
            capaPreview = null;

            StateHasChanged();

        }
        catch (Exception e)
        {
            Console.WriteLine($"Erro ao salvar: {e.Message}");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Erro!",
                Detail = "Algo deu errado ao salvar os dados. Verifique os campos e tente novamente!!!",
                Duration = 4000 
            });
        }

         
    }
    private void NotificarCampoObrigatorio(string campo)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Warning,
            Summary = "Campo obrigatório",
            Detail = $"O campo '{campo}' é obrigatório.",
            Duration = 3000
        });
    }


   
}
