@page "/area-administrador"
@using Biblioteca.Client.Pages.Dialog
@inject IUsuarioService _usuarioService
@attribute [Authorize(Roles = "Administrador")]
@inject DialogService DialogService


@if (usuarios == null)
{
    <p><em>Carregando...</em></p>
}
else
{
    <RadzenStack Gap="1rem">
    
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
            <RadzenIcon Icon="people_alt" Style="font-size: 32px; color: #6a1b9a;" />
            <RadzenText TextStyle="TextStyle.H5" >
                Gestão de Usuários
            </RadzenText>
        </RadzenStack>
        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="@($"{@TotalUsuarios} Total")" />
    </RadzenStack>


    <RadzenDataGrid Data="@usuarios" AllowPaging="true" PageSize="5" AllowSorting="true" TItem="UsuarioResponse" >
        
        <Columns>
            
            <RadzenDataGridColumn TItem="UsuarioResponse" Property="Nome" Title="Nome" />
            
            <RadzenDataGridColumn TItem="UsuarioResponse" Property="Email" Title="Email" />
            
            <RadzenDataGridColumn TItem="UsuarioResponse" Property="Status" Title="Status">
                <Template Context="usuario">
                    <RadzenBadge 
                        Text="@usuario.Status.ToString()"
                        BadgeStyle="@(usuario.Status.ToString() == "Ativo" ? BadgeStyle.Success : BadgeStyle.Danger)"
                        Icon="@(usuario.Status.ToString() == "Ativo" ? "verified" : "block")"
                        Style="color: white; padding: 5px 10px;"
                    />
                </Template>
            </RadzenDataGridColumn>
            
            <RadzenDataGridColumn TItem="UsuarioResponse" Property="UltimoLogin" Title="Último Login" FormatString="{0:dd/MM/yyyy}" />
            
            

            <RadzenDataGridColumn TItem="UsuarioResponse" Title="Ações" Sortable="false" Filterable="false" Width="120px">
                <Template Context="usuario">
        
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
            
                        
            
                        <RadzenButton Icon="edit" 
                                      ButtonStyle="ButtonStyle.Success" 
                                      Variant="Variant.Flat" 
                                      Title="Editar Detalhes / Redefinir Senha"
                                      Click="@(() => AbrirEdicao(usuario))" />
                          
                    </RadzenStack>
                </Template>
            </RadzenDataGridColumn>
            
        </Columns>
    </RadzenDataGrid>

</RadzenStack>

}


@code {
    private List<UsuarioResponse> usuarios = new();
    private int TotalUsuarios => usuarios?.Count ?? 0;
    public EventCallback OnUsuarioEditado { get; set; }

    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            usuarios = await _usuarioService.ListarUsuarios();
            
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine("Acesso não autorizado ou token expirado.");
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
            throw new Exception(e.Message);
        }
    }

    
    private async Task AbrirEdicao(UsuarioResponse usuario)
    {
        var result = await DialogService.OpenAsync<EditUserDialog>(
            "Editar Usuário",
            new Dictionary<string, object>
            {
                { "Usuario", usuario }
            },
            new DialogOptions
            {
                Width = "450px",
                CloseDialogOnOverlayClick = false
            });

        if (result is UsuarioRequest request)
        {
            await _usuarioService.UpdateUsuario(request);
            await OnUsuarioEditado.InvokeAsync();

            await RecarregarDados();
        }
    }
    
  
    private async Task RecarregarDados()
    {
       usuarios = await _usuarioService.ListarUsuarios();
        
        StateHasChanged();
    }

}